# Concept
I wrote the down the basic concept. This contains the problem, a non-technical solution and a technical solution. At this point I planned to use the NodeMCU firmware and send the push notifications directly from the ESP8266. Maybe this could be problematic because I am not sure that it is possible to authenticate with the Apple Push Notification (APN) servers. So maybe I'll use something like a raspberry pi instead. But for now I write a NodeMCU because this would be the better solution since normally micro-controller are more reliable than mini computers.
# Implementing the iOS App
I implemented the iOS app using Swift and SwiftUI for the UI. The app is not designed pretty. But this is not important for now. I will make a note that designing the app could be a step later. The app is sending a UDP packet with the device token on registration. Then when the app received a push notification, it checks that the device is connected to the given WiFi. A problem could be that since iOS 13.2 apple decided that to access WiFi information the app needs the permission to access the location. In iOS 13 the authorization system for the location access "always" has changed fundamentally. It is not possible to just request that permission. For now the use is just advised to set the permission manually. Sometimes iOS asks randomly whether the use wants to upgrade the permission. This should be fixed in the future, but is not that important.
# Write the NodeMCU firmware
I have a NodeMCU v3 board for testing.
## JWT token
To authorize to the APN server a self generated JWT token is required as on the [Apple Documentation](https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/establishing_a_token-based_connection_to_apns). This token not be valid for more than one hour. So it is not just possible to generate one on setup. The JWT token must be used using the ES256 algorithm. The crypto module in the NodeMCU firmware only supports AES256 and basic hash algorithms. The SHA256 hash not the problem since that algorithm is supported natively by the firmware but the ECDSA. I found a [fork of the ArduinoJWT library](https://github.com/Barmaley13/ArduinoJWT) that supports signing JWT tokens with ES256 on GitHub. Maybe I could use this library, without using the NodeMCU firmware. As on the documentation of the library, the library supports the ESP8266 processor. The problem with this library is that the header is hardcoded. But I need to set the `kid` field in the header. But I could use parts of the library. I only need creating a JWT token not validating one, and only the one singing algorithm. 
## HTTP/2
Another point according to the [Apple Documentation](https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/sending_notification_requests_to_apns) is is required to use the HTTP/2 protocol to communicate with their servers. The NodeMCU firmware has a http module, but when I took a look at the [source code](https://github.com/nodemcu/nodemcu-firmware/blob/master/app/http/httpclient.c#L244) of the module I found that only HTTP/1.1 are supported. So I will need to implement a HTTP/2 client on my own. 
## Move logic to Amazon AWS
But all this is very complicated and it is easier to just move that logic into an external server on which just libraries can be used. So I will move the communication of to the APN server into a AWS Lambda. Another reason why to use this options is that in the apple documentation there is a notice that the token has not to be changed more often than every 20 minutes. But when every NodeMCU has its own token handling the cannot be guaranteed. And when this system is shipped to different customer, the private key for signing JWT token should not be given to every customer. But when the key is only stored in the AWS lambda the customer wont have access to it.
# AWS Lambda
There are two AWS lambdas. One is called when somebody ringed at the door, the other when a device was registered. The second once has a additional parameter which device whether or not the device token was already in the list. That lambdas can be called using a HTTP request containing the WiFi name in which the notification should be delivered (see at [Implementing the iOS App](#implementing-the-ios-app)) and a list of device tokens.
## Modules
The AWS lambda code is separated into four modules. Two are just containing the entrypoints for the lambdas. One is sending the APN message has renews the token (which is stored in a secret manager) if the old one expired. And there is a simple module which collects all necessary files and packs them into a ZIP file which then can be uploaded to the lambda function.
